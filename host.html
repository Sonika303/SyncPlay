<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Host</title>
<style>
body{margin:0;font-family:Arial;background:#fff}
#top{padding:10px;display:flex;justify-content:space-between;border-bottom:1px solid #ddd}
#lobby,#countdown,#gameOver{text-align:center}
#players{margin-top:10px}
#players div{padding:6px;border-bottom:1px solid #eee}
canvas{display:none;margin:auto;border:1px solid #ccc}
button{padding:8px 12px;margin:6px}
.card{border:1px solid #ccc;padding:16px;margin:20px auto;width:260px;border-radius:8px;cursor:pointer}
</style>
</head>
<body>

<div id="top">
  <div>Code: <b id="code"></b></div>
  <button onclick="exit()">Exit</button>
</div>

<div id="lobby">
  <h2>Select Game</h2>
  <div class="card" onclick="selectGame()">Dodge Falling Objects<br><small>Min 2 players</small><br><button>Play</button></div>
  <div id="players"><h3>Players:</h3></div>
</div>

<div id="countdown" style="display:none;font-size:60px"></div>
<canvas id="game" width="800" height="400"></canvas>

<div id="gameOver" style="display:none">
  <h2>Game Over</h2>
  <h3 id="winner"></h3>
  <button onclick="exit()">Exit</button>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const username = sessionStorage.getItem("u");
if(!username) location.href="index.html";

const partyCode = String(Math.floor(10000+Math.random()*90000));
code.textContent = partyCode;

const peer = new Peer(partyCode);
const players = {}; // peerId -> {name, ready, conn, x, y, vy, alive}
let phase = "lobby";
let selectedGame = null;
let objects = [];

peer.on("connection", conn => {
  players[conn.peer] = {name:"", ready:false, conn, x:400, y:350, vy:0, alive:true};

  conn.on("data", d => {
    if(d.type==="join") players[conn.peer].name=d.name;
    if(d.type==="ready") players[conn.peer].ready=d.value;
    if(d.type==="move" && phase==="game") {
      const p = players[conn.peer];
      p.x += d.dx;
      if(d.jump && p.y>=350) p.vy=-12;
    }
    broadcastLobby();
  });

  conn.on("close", ()=>{ delete players[conn.peer]; broadcastLobby(); });
  broadcastLobby();
});

// Send lobby state to all players
function broadcastLobby(){
  let html="<h3>Players:</h3>";
  Object.values(players).forEach(p=>{
    html += `<div>${p.name} ${p.ready?"✅":"❌"}</div>`;
  });
  playersDiv.innerHTML = html;

  Object.values(players).forEach(p=>{
    p.conn.send({type:"lobby",players:Object.values(players)});
  });
}

// Select game only allowed if 2+ ready players
function selectGame(){
  const readyCount = Object.values(players).filter(p=>p.ready).length;
  if(readyCount<2) return alert("At least 2 ready players required!");
  selectedGame="dodge";
  startCountdown(3);
}

function startCountdown(n){
  phase="countdown";
  lobby.style.display="none";
  countdown.style.display="block";
  countdown.textContent=n;
  Object.values(players).forEach(p=>p.conn.send({type:"countdown",value:n}));
  if(n>0) setTimeout(()=>startCountdown(n-1),1000);
  else beginGame();
}

// GAME
const ctx = game.getContext("2d");
const gravity = 0.6;

function beginGame(){
  phase="game";
  countdown.style.display="none";
  game.style.display="block";
  objects=[];
  Object.values(players).forEach(p=>p.alive=true);
  spawnObjects();
  requestAnimationFrame(loop);
}

function spawnObjects(){
  if(phase!=="game") return;
  const x = Math.random()*780+10;
  objects.push({x:x,y:-20,vy:2+Math.random()*3});
  setTimeout(spawnObjects,1000);
}

function loop(){
  ctx.clearRect(0,0,800,400);
  ctx.fillStyle="#ddd";
  ctx.fillRect(0,380,800,20); // ground

  ctx.fillStyle="red";
  objects.forEach(o=>{ o.y+=o.vy; ctx.fillRect(o.x,o.y,20,20); });

  let alivePlayers=[];
  Object.values(players).forEach(p=>{
    if(!p.alive) return;
    p.vy += gravity;
    p.y += p.vy;
    if(p.y>350){ p.y=350; p.vy=0; }
    ctx.fillStyle="#000";
    ctx.beginPath();
    ctx.arc(p.x,p.y-10,10,0,Math.PI*2); ctx.fill();
    ctx.fillText(p.name,p.x-15,p.y-25);

    if(objects.some(o=>Math.abs(o.x-p.x)<20 && Math.abs(o.y-(p.y-10))<20)){
      p.alive=false;
    } else alivePlayers.push(p.name);
  });

  if(Object.values(players).every(p=>!p.alive)){
    phase="over"; game.style.display="none"; gameOver.style.display="block";
    winner.textContent = alivePlayers.length>0?"Winner: "+alivePlayers.join(", "):"No winner!";
    return;
  }

  if(phase==="game") requestAnimationFrame(loop);
}

function exit(){ sessionStorage.clear(); location.href="index.html"; }
</script>
</body>
</html>
