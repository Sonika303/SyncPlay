<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Host</title>
<style>
body{margin:0;font-family:Arial;background:#fff}
#top{
  padding:10px;
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid #ddd;
}
#lobby,#countdown,#gameOver{text-align:center}
#players div{padding:6px;border-bottom:1px solid #eee}
canvas{display:none;margin:auto;border:1px solid #ccc}
button{padding:8px 12px;margin:6px}
</style>
</head>
<body>

<div id="top">
  <div>Code: <b id="code"></b></div>
  <button onclick="exit()">Exit</button>
</div>

<div id="lobby">
  <h2>Lobby</h2>
  <div id="players"></div>
  <button onclick="startGame()">Start</button>
</div>

<div id="countdown" style="display:none;font-size:60px"></div>

<canvas id="game" width="800" height="400"></canvas>

<div id="gameOver" style="display:none">
  <h2>Game Over</h2>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const username=sessionStorage.getItem("u");
if(!username) location.href="index.html";

const partyCode=String(Math.floor(10000+Math.random()*90000));
code.textContent=partyCode;

const peer=new Peer(partyCode);
const players={};
let phase="lobby";

peer.on("connection",conn=>{
  players[conn.peer]={id:conn.peer,name:"",ready:false,conn,x:50,y:320,vy:0};
  conn.on("data",d=>{
    if(d.type==="join") players[conn.peer].name=d.name;
    if(d.type==="ready") players[conn.peer].ready=d.value;
    if(d.type==="move"&&phase==="game"){
      const p=players[conn.peer];
      p.x+=d.dx;
      if(d.jump&&p.y>=320){p.vy=-12;vibrate();}
    }
    syncLobby();
  });
  syncLobby();
});

function syncLobby(){
  playersDiv.innerHTML="";
  Object.values(players).forEach(p=>{
    playersDiv.innerHTML+=`<div>${p.name} ${p.ready?"✅":"❌"}</div>`;
    p.conn.send({type:"lobby",players,code:partyCode});
  });
}

function startGame(){
  if(!Object.values(players).every(p=>p.ready)) return alert("All must be ready");
  lobby.style.display="none";
  startCountdown(3);
}

function startCountdown(n){
  countdown.style.display="block";
  countdown.textContent=n;
  Object.values(players).forEach(p=>p.conn.send({type:"countdown",value:n}));
  if(n>0) setTimeout(()=>startCountdown(n-1),1000);
  else beginGame();
}

const ctx=game.getContext("2d");
const gravity=0.6;

function beginGame(){
  phase="game";
  countdown.style.display="none";
  game.style.display="block";
  loop();
}

function loop(){
  ctx.clearRect(0,0,800,400);
  ctx.fillRect(0,350,800,2);
  Object.values(players).forEach(p=>{
    p.vy+=gravity;
    p.y+=p.vy;
    if(p.y>320){p.y=320;p.vy=0;}
    drawStickman(p);
  });
  if(phase==="game") requestAnimationFrame(loop);
}

function drawStickman(p){
  ctx.strokeStyle="#000";
  ctx.beginPath();
  ctx.arc(p.x,p.y-25,6,0,Math.PI*2);
  ctx.moveTo(p.x,p.y-19);
  ctx.lineTo(p.x,p.y);
  ctx.stroke();
  ctx.fillText(p.name,p.x-10,p.y-35);
}

function vibrate(){navigator.vibrate&&navigator.vibrate(50)}

function exit(){
  sessionStorage.clear();
  location.href="index.html";
}
</script>

</body>
</html>
