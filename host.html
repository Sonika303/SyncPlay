<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Party Room</title>
<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
  text-align:center;
  padding-top:40px;
}
.card{
  background:#1e1e1e;
  width:450px;
  margin:auto;
  padding:30px;
  border-radius:12px;
  box-shadow:0 0 30px rgba(0,0,0,0.5);
}
.player{padding:8px;background:#333;margin:5px;border-radius:6px;}
.host{background:#4CAF50;}
button{
  padding:10px 15px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  margin:6px;
}
.primary{background:#4CAF50;color:white;}
.secondary{background:#1976d2;color:white;}
.danger{background:#e53935;color:white;}
select{padding:8px;border-radius:6px;margin:10px;}
</style>
</head>
<body>

<div class="card">

<h2 id="partyCode"></h2>

<h3>Players</h3>
<div id="playerList"></div>

<hr>

<div id="gameMenu" style="display:none">
<h3>Game Menu</h3>
<select id="gameSelect">
<option value="quiz">Quiz</option>
</select>
<br>
<button id="startGameBtn" class="primary">Start Game</button>
</div>

<button id="leaveBtn" class="danger">Leave Party</button>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getDatabase, ref, set, get, onValue, remove, onDisconnect, update }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig={
apiKey:"AIzaSyCODp3h025sM3jl7Ji0GJgVuGoWCD1wddU",
authDomain:"syncplay-17b6e.firebaseapp.com",
databaseURL:"https://syncplay-17b6e-default-rtdb.firebaseio.com",
projectId:"syncplay-17b6e"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getDatabase(app);

const params=new URLSearchParams(window.location.search);
const code=params.get("code");
if(!code) window.location="index.html";

localStorage.setItem("party",code);

document.getElementById("partyCode").innerText="Party Code: "+code;

const playerListDiv=document.getElementById("playerList");

onAuthStateChanged(auth, async(user)=>{
if(!user) return window.location="index.html";

localStorage.setItem("uid",user.uid);

const partyRef=ref(db,"parties/"+code);
const partySnap=await get(partyRef);
if(!partySnap.exists()) return window.location="index.html";

const hostId=partySnap.val().host;

const userSnap=await get(ref(db,"users/"+user.uid));
const username=userSnap.exists()?userSnap.val().username:user.email;

const playerRef=ref(db,"parties/"+code+"/players/"+user.uid);

await set(playerRef,{username:username,score:0});
onDisconnect(playerRef).remove();

if(user.uid===hostId){
document.getElementById("gameMenu").style.display="block";
}

onValue(ref(db,"parties/"+code+"/players"),snap=>{
playerListDiv.innerHTML="";
snap.forEach(child=>{
const div=document.createElement("div");
div.className="player";
if(child.key===hostId) div.classList.add("host");
div.innerText=child.val().username+" ("+(child.val().score||0)+")";
playerListDiv.appendChild(div);
});
});

onValue(ref(db,"parties/"+code+"/selectedGame"),snap=>{
if(!snap.exists()) return;
const game=snap.val();
if(user.uid===hostId){
window.location="/games/Quiz/game.html";
}else{
window.location="/games/Quiz/controller.html";
}
});

document.getElementById("startGameBtn").onclick=async()=>{
const game=document.getElementById("gameSelect").value;
await update(ref(db,"parties/"+code),{
selectedGame:game,
gameState:"lobby"
});
};

document.getElementById("leaveBtn").onclick=async()=>{
if(user.uid===hostId){
await remove(partyRef);
}else{
await remove(playerRef);
}
window.location="index.html";
};

});

</script>
</body>
</html>
