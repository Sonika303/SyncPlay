<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Host</title>
<style>
body{margin:0;background:#fff}
#top{
  padding:10px;
  border-bottom:1px solid #ccc;
  display:flex;
  justify-content:space-between;
}
canvas{
  display:block;
  width:100vw;
  height:calc(100vh - 50px);
}
</style>
</head>
<body>

<div id="top">
  <div>Code: <b id="code"></b></div>
  <button onclick="location.href='index.html'">Exit</button>
</div>

<canvas id="c"></canvas>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const name=sessionStorage.getItem("u");
if(!name) location.href="index.html";

const partyCode=(Math.floor(10000+Math.random()*90000))+"";
code.textContent=partyCode;

const peer=new Peer(partyCode);
const players={};
let it=null;

const canvas=c;
const ctx=canvas.getContext("2d");

function resize(){
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight-50;
}
window.onresize=resize;
resize();

peer.on("connection",conn=>{
  players[conn.peer]={
    id:conn.peer,
    x:Math.random()*canvas.width,
    y:Math.random()*canvas.height,
    conn
  };
  if(!it) it=conn.peer;

  conn.on("data",d=>{
    if(d.type==="move"){
      const p=players[conn.peer];
      p.x+=d.dx;
      p.y+=d.dy;
      p.x=Math.max(10,Math.min(canvas.width-10,p.x));
      p.y=Math.max(10,Math.min(canvas.height-10,p.y));
      checkTag();
    }
  });
});

function checkTag(){
  const itP=players[it];
  for(const id in players){
    if(id===it) continue;
    const p=players[id];
    const dx=p.x-itP.x;
    const dy=p.y-itP.y;
    if(Math.hypot(dx,dy)<20){
      it=id;
      break;
    }
  }
  broadcast();
}

function broadcast(){
  Object.values(players).forEach(p=>{
    p.conn.send({type:"state",it});
  });
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(const id in players){
    const p=players[id];
    ctx.beginPath();
    ctx.fillStyle=id===it?"red":"blue";
    ctx.arc(p.x,p.y,10,0,Math.PI*2);
    ctx.fill();
  }
  requestAnimationFrame(draw);
}
draw();
</script>

</body>
</html>
