<!DOCTYPE html>
<html>
<head>
  <title>Host</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #ffffff;
      color: #000;
    }
    #top {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    canvas {
      display: block;
      margin: 20px auto;
      border: 1px solid #ccc;
      background: #fff;
    }
  </style>
</head>
<body>

<div id="top">
  <div>Party Code: <b id="partyCode"></b></div>
  <button onclick="exitParty()">Exit</button>
</div>

<canvas id="gameCanvas" width="800" height="400"></canvas>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const username = sessionStorage.getItem("username");
if (!username) {
  window.location.href = "index.html";
}

const code = Math.floor(10000 + Math.random() * 90000).toString();
document.getElementById("partyCode").textContent = code;

const peer = new Peer(code);
const players = {};
let itPlayer = null;
const ctx = gameCanvas.getContext("2d");

peer.on("connection", conn => {
  players[conn.peer] = {
    id: conn.peer,
    name: "",
    x: Math.random() * 700,
    y: 320,
    conn
  };

  conn.on("data", data => handleData(conn.peer, data));
});

function handleData(id, data) {
  if (data.type === "join") {
    players[id].name = data.name;
    if (!itPlayer) itPlayer = id;
    sendState();
  }

  if (data.type === "move") {
    players[id].x += data.dx;
    players[id].x = Math.max(0, Math.min(760, players[id].x));
  }

  if (data.type === "tag" && id === itPlayer) {
    for (const pid in players) {
      if (pid !== id && Math.abs(players[pid].x - players[id].x) < 30) {
        itPlayer = pid;
        break;
      }
    }
    sendState();
  }
}

function sendState() {
  Object.values(players).forEach(p => {
    p.conn.send({
      type: "state",
      it: itPlayer
    });
  });
}

function drawStickman(p, isIt) {
  ctx.strokeStyle = isIt ? "red" : "black";
  ctx.lineWidth = 2;

  ctx.beginPath();
  ctx.arc(p.x + 20, p.y, 8, 0, Math.PI * 2);
  ctx.moveTo(p.x + 20, p.y + 8);
  ctx.lineTo(p.x + 20, p.y + 30);
  ctx.lineTo(p.x + 5, p.y + 45);
  ctx.moveTo(p.x + 20, p.y + 30);
  ctx.lineTo(p.x + 35, p.y + 45);
  ctx.stroke();
}

function gameLoop() {
  ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
  Object.values(players).forEach(p => {
    drawStickman(p, p.id === itPlayer);
  });
  requestAnimationFrame(gameLoop);
}
gameLoop();

function exitParty() {
  sessionStorage.clear();
  window.location.href = "index.html";
}
</script>

</body>
</html>
