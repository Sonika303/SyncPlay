<div id="lobby">
  <h2>Select Game</h2>

  <div id="carousel">
    <button onclick="move(-1)">◀</button>
    <div id="card"></div>
    <button onclick="move(1)">▶</button>
  </div>

  <div id="readyInfo">Ready: 0</div>

  <button onclick="startGame()">Start Game</button>
</div>

<div id="countdown" style="display:none;font-size:48px;text-align:center;margin-top:50px;"></div>
<canvas id="c" width="800" height="400" style="display:none"></canvas>

<script>
const games=[{name:"Stickman Tag",id:"tag"},{name:"Dot Chase",id:"dot"}];
let selectedGame=0;
let phase="lobby";
let readyPlayers={};
let connections=[];

const peer=new Peer(partyCode);

peer.on("connection",conn=>{
  connections.push(conn);
  readyPlayers[conn.peer]=false;

  conn.on("data",d=>{
    if(d.type==="ready"){
      readyPlayers[conn.peer]=d.value;
      syncLobby();
    }
    if(d.type==="browse"){
      move(d.dir);
    }
  });

  syncLobby();
});

function move(dir){
  selectedGame=(selectedGame+dir+games.length)%games.length;
  syncLobby();
}

function syncLobby(){
  card.textContent=games[selectedGame].name;
  const readyCount=Object.values(readyPlayers).filter(v=>v).length;
  readyInfo.textContent=`Ready: ${readyCount}/${connections.length}`;
  connections.forEach(c=>{
    c.send({
      type:"lobby",
      selectedGame,
      ready:readyPlayers
    });
  });
}

function startGame(){
  const allReady=Object.values(readyPlayers).every(v=>v);
  if(!allReady){
    alert("All players must be ready");
    return;
  }
  startCountdown(3);
}

function startCountdown(n){
  lobby.style.display="none";
  countdown.style.display="block";
  countdown.textContent=n;
  connections.forEach(c=>c.send({type:"countdown",value:n}));

  if(n>0){
    setTimeout(()=>startCountdown(n-1),1000);
  }else{
    countdown.style.display="none";
    c.style.display="block";
    connections.forEach(c=>c.send({type:"start",game:games[selectedGame].id}));
  }
}
</script>
