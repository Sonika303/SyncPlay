<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SyncPlay</title>
<style>
body{
  margin:0;
  font-family: 'Arial', sans-serif;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#f0f0f0;
  color:#222;
}
.container{
  width:380px;
  background:#fff;
  border-radius:16px;
  padding:30px;
  box-shadow:0 0 25px rgba(0,0,0,0.2);
  text-align:center;
  animation:fadeIn 0.5s ease;
}
h2{
  margin-bottom:20px;
  color:#222;
  animation:slideDown 0.5s ease;
}
input,button{
  width:100%;
  padding:14px;
  margin:8px 0;
  border-radius:10px;
  border:none;
  font-size:16px;
  transition:0.2s;
}
input{background:#eee;color:#222;}
button{background:#00bfa5;color:white;font-weight:bold;cursor:pointer;}
button:hover{background:#009e88;}
#partyFrame{display:none;}
#playerList{background:#f5f5f5;margin:10px 0;padding:10px;border-radius:8px;max-height:120px;overflow:auto;box-shadow:inset 0 0 5px rgba(0,0,0,0.1);}
@keyframes fadeIn{from{opacity:0} to{opacity:1}}
@keyframes slideDown{from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0)}}
</style>
</head>
<body>

<div class="container">
  <h2>SyncPlay</h2>
  
  <div id="loginFrame">
    <input id="username" placeholder="Enter Username">
    <button id="googleSignIn">Sign in with Google</button>
  </div>
  
  <div id="partyFrame">
    <p id="usernameDisplay"></p>
    <button id="createPartyBtn">Create Party</button>
    <input id="joinCode" placeholder="Enter 5-digit Code">
    <button id="joinPartyBtn">Join Party</button>
    <div id="playerList"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-analytics.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCODp3h025sM3jl7Ji0GJgVuGoWCD1wddU",
  authDomain: "syncplay-17b6e.firebaseapp.com",
  databaseURL: "https://syncplay-17b6e-default-rtdb.firebaseio.com",
  projectId: "syncplay-17b6e",
  storageBucket: "syncplay-17b6e.firebasestorage.app",
  messagingSenderId: "86016195929",
  appId: "1:86016195929:web:40262a28786f2ead712048",
  measurementId: "G-3NBT4GJ0FX"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

const loginFrame = document.getElementById("loginFrame");
const partyFrame = document.getElementById("partyFrame");
const googleBtn = document.getElementById("googleSignIn");
const usernameInput = document.getElementById("username");
const usernameDisplay = document.getElementById("usernameDisplay");
const createBtn = document.getElementById("createPartyBtn");
const joinCodeInput = document.getElementById("joinCode");
const joinBtn = document.getElementById("joinPartyBtn");
const playerList = document.getElementById("playerList");

googleBtn.onclick = async () => {
  const customUsername = usernameInput.value.trim();
  if(!customUsername) return alert("Enter a username first");
  try{
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    sessionStorage.setItem("u", customUsername);
    sessionStorage.setItem("uid", user.uid);
    showPartyFrame();
  } catch(err){ alert(err.message); }
};

onAuthStateChanged(auth, user=>{
  if(user && sessionStorage.getItem("u")){
    showPartyFrame();
  }
});

function showPartyFrame(){
  loginFrame.style.display="none";
  partyFrame.style.display="block";
  usernameDisplay.textContent = `Hello, ${sessionStorage.getItem("u")}`;
  const code = sessionStorage.getItem("c");
  if(code){
    const playersRef = ref(db,"parties/"+code+"/players");
    onValue(playersRef, snapshot=>{
      const playersData = snapshot.val() || {};
      playerList.innerHTML="<b>Players in party:</b>";
      Object.values(playersData).forEach(p=>{
        const div = document.createElement("div");
        div.textContent = p.username;
        playerList.appendChild(div);
      });
    });
  }
}

// Create Party
createBtn.onclick = ()=>{
  const partyCode = String(Math.floor(10000 + Math.random()*90000));
  sessionStorage.setItem("partyCode", partyCode);
  const uid = sessionStorage.getItem("uid");
  const username = sessionStorage.getItem("u");
  
  set(ref(db,"parties/"+partyCode),{
    gameState:"lobby",
    countdown:3,
    winner:"",
    rules:{minPlayers:2,maxPlayers:4,gameTime:60},
    players:{ [uid]: { username, x:400, y:350, vx:0, vy:0, alive:true } }
  });

  sessionStorage.setItem("c", partyCode);
  location.href="host.html";
};

// Join Party
joinBtn.onclick = ()=>{
  const code = joinCodeInput.value.trim();
  if(code.length!==5) return alert("Invalid code");
  sessionStorage.setItem("c", code);
  location.href="controller.html";
};
</script>
</body>
</html>
