<!DOCTYPE html>
<html>
<head>
  <title>Host</title>
</head>
<body>

<h2>Display Screen</h2>
<p>Party Code: <b id="partyCode"></b></p>

<select id="gameSelect">
  <option value="">Select Game</option>
  <option value="tag">Tag</option>
</select>

<button onclick="exitParty()">Exit Party</button>

<div id="gameContainer"></div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const username = sessionStorage.getItem("username");
if (!username) location.href = "index.html";

const code = Math.floor(10000 + Math.random() * 90000).toString();
partyCode.innerText = code;

const peer = new Peer(code);
const players = {}; // id -> { name, conn }

peer.on("connection", conn => {
  conn.on("data", data => handle(conn.peer, data));
  players[conn.peer] = { conn, name: "..." };
});

function handle(id, data) {
  if (data.type === "join") {
    players[id].name = data.name;
    broadcast({ type: "players", players: getPlayerList() });
  }
}

function broadcast(msg) {
  Object.values(players).forEach(p => p.conn.send(msg));
}

function getPlayerList() {
  return Object.entries(players).map(([id, p]) => ({
    id, name: p.name
  }));
}

gameSelect.onchange = () => {
  if (gameSelect.value === "tag") {
    gameContainer.innerHTML =
      `<iframe src="tag.html" width="800" height="500"></iframe>`;
    broadcast({ type: "game", game: "tag" });
  }
};

function exitParty() {
  location.href = "index.html";
}
</script>

</body>
</html>
