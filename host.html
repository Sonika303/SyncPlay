<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SyncPlay Host</title>

<style>
body{margin:0;font-family:Arial;background:#f0f0f0;display:flex;flex-direction:column;align-items:center}
#top{width:100%;padding:10px;display:flex;justify-content:space-between;background:#fff}
#players{width:90%;margin:10px;background:#fff;padding:10px;border-radius:8px}
#players div{padding:6px;border-bottom:1px solid #ddd}
.gameCard{background:#fff;padding:12px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.1);cursor:pointer;text-align:center}
.note{font-size:12px;color:#888;margin-top:4px}
canvas{border:1px solid #ccc;margin-top:10px;display:none}
</style>
</head>

<body>

<div id="top">
  <div>Party Code: <b id="code"></b></div>
  <button onclick="exit()">Exit</button>
</div>

<div id="players"><h3>Players:</h3></div>

<div class="gameCard" id="gameBtn">
  Dodge Falling Objects
  <div class="note">Minimum 2 players required</div>
</div>

<canvas id="game" width="800" height="400"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

/* CONFIG */
const app = initializeApp({
  apiKey: "AIzaSyCODp3h025sM3jl7Ji0GJgVuGoWCD1wddU",
  authDomain: "syncplay-17b6e.firebaseapp.com",
  databaseURL: "https://syncplay-17b6e-default-rtdb.firebaseio.com",
  projectId: "syncplay-17b6e"
});

const auth = getAuth(app);
const db = getDatabase(app);

const code = sessionStorage.getItem("c");
if(!code) location.href="index.html";
document.getElementById("code").textContent = code;

const playersDiv = document.getElementById("players");
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let players = {};
let gameRunning = false;

/* WAIT FOR AUTH */
onAuthStateChanged(auth, user=>{
  if(!user) return location.href="index.html";

  /* LIVE PLAYERS */
  onValue(ref(db,`parties/${code}/players`), snap=>{
    players = snap.val() || {};
    playersDiv.innerHTML="<h3>Players:</h3>";
    Object.values(players).forEach(p=>{
      playersDiv.innerHTML += `<div>${p.username}</div>`;
    });
  });
});

/* START GAME */
document.getElementById("gameBtn").onclick = ()=>{
  if(Object.keys(players).length < 2){
    alert("At least 2 players required");
    return;
  }
  startGame();
};

function startGame(){
  gameRunning = true;
  canvas.style.display="block";
  requestAnimationFrame(loop);
}

function loop(){
  if(!gameRunning) return;
  ctx.clearRect(0,0,800,400);

  let alive = 0;
  for(const uid in players){
    const p = players[uid];
    if(p.alive===false) continue;
    alive++;
    ctx.fillStyle="#2196f3";
    ctx.beginPath();
    ctx.arc(p.x||400,p.y||350,10,0,Math.PI*2);
    ctx.fill();
  }

  if(alive <= 1){
    gameRunning = false;
    alert("Game Over");
    return;
  }

  requestAnimationFrame(loop);
}

window.exit = ()=>{
  sessionStorage.clear();
  location.href="index.html";
};
</script>
</body>
</html>
