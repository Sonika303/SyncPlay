<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pong - SyncPlay</title>
  <style>
    body { margin: 0; background: #222; color: white; font-family: sans-serif; text-align:center; }
    canvas { background: #333; display: block; margin: 20px auto; }
    #players { margin-top: 10px; }
    #link { margin-top: 10px; font-size:14px; color:#aaa; }
  </style>
</head>
<body>
<h1>Pong - SyncPlay</h1>
<canvas id="gameCanvas" width="600" height="400"></canvas>
<p id="link">Open controller on phone: <b>controller.html?game=pong</b></p>
<div id="players"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="../firebase.js"></script>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let players = {};
let ball = {x: 300, y: 200, vx: 3, vy: 3, r: 10};

// Listen for paddle positions
const inputsRef = db.ref('pongInputs');
inputsRef.on('value', snapshot => {
  players = snapshot.val() || {};
  document.getElementById('players').innerHTML = "Players: " + Object.keys(players).length;
});

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Draw paddles
  let i = 0;
  for(let id in players){
    const p = players[id];
    ctx.fillStyle = i===0 ? "red" : "blue";
    ctx.fillRect(i===0?10:canvas.width-30, p.y, 20, 80);
    i++;
  }

  // Draw ball
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
  ctx.fillStyle = "white";
  ctx.fill();

  // Move ball
  ball.x += ball.vx;
  ball.y += ball.vy;

  if(ball.y<0 || ball.y>canvas.height) ball.vy *= -1;

  // Paddle collision
  i=0;
  for(let id in players){
    const p = players[id];
    const px = i===0?10:canvas.width-30;
    if(ball.x + ball.r > px && ball.x - ball.r < px+20 &&
       ball.y + ball.r > p.y && ball.y - ball.r < p.y+80){
      ball.vx *= -1;
    }
    i++;
  }

  requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>
