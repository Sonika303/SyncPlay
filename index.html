<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SyncPlay</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#f0f0f0;
}
.container{
  width:400px;
  background:#fff;
  border-radius:16px;
  padding:40px;
  box-shadow:0 0 25px rgba(0,0,0,.2);
  text-align:center;
}
input,button{
  width:100%;
  padding:14px;
  margin:8px 0;
  border-radius:10px;
  border:none;
  font-size:16px;
}
input{background:#eee}
button{
  background:#00bfa5;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}
button:hover{background:#009e88}
#partyFrame{display:none}
#playerList{
  background:#f5f5f5;
  padding:10px;
  border-radius:8px;
  max-height:140px;
  overflow:auto;
}
</style>
</head>

<body>
<div class="container">
  <h2>SyncPlay</h2>

  <div id="loginFrame">
    <input id="username" placeholder="Enter Username">
    <button id="googleSignIn">Sign in with Google</button>
  </div>

  <div id="partyFrame">
    <p id="usernameDisplay"></p>
    <button id="createPartyBtn">Create Party</button>
    <input id="joinCode" placeholder="5-digit Code">
    <button id="joinPartyBtn">Join Party</button>
    <div id="playerList"><b>Players:</b></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCODp3h025sM3jl7Ji0GJgVuGoWCD1wddU",
  authDomain: "syncplay-17b6e.firebaseapp.com",
  databaseURL: "https://syncplay-17b6e-default-rtdb.firebaseio.com",
  projectId: "syncplay-17b6e",
  appId: "1:86016195929:web:40262a28786f2ead712048"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

const loginFrame = document.getElementById("loginFrame");
const partyFrame = document.getElementById("partyFrame");
const usernameInput = document.getElementById("username");
const usernameDisplay = document.getElementById("usernameDisplay");
const playerList = document.getElementById("playerList");

const showParty = ()=>{
  loginFrame.style.display="none";
  partyFrame.style.display="block";
  usernameDisplay.textContent = `Hello, ${sessionStorage.getItem("u")}`;

  const code = sessionStorage.getItem("c");
  if(!code) return;

  onValue(ref(db, `parties/${code}/players`), snap=>{
    const players = snap.val() || {};
    playerList.innerHTML="<b>Players:</b>";
    Object.values(players).forEach(p=>{
      const d=document.createElement("div");
      d.textContent=p.username;
      playerList.appendChild(d);
    });
  });
};

// Login
document.getElementById("googleSignIn").onclick = async ()=>{
  const name = usernameInput.value.trim();
  if(!name) return alert("Enter username");

  const res = await signInWithPopup(auth, provider);
  sessionStorage.setItem("u", name);
  sessionStorage.setItem("uid", res.user.uid);
  showParty();
};

onAuthStateChanged(auth, u=>{
  if(u && sessionStorage.getItem("u")) showParty();
});

// Create Party
document.getElementById("createPartyBtn").onclick = async ()=>{
  const code = String(Math.floor(10000 + Math.random()*90000));
  const uid = sessionStorage.getItem("uid");
  const username = sessionStorage.getItem("u");

  await set(ref(db, `parties/${code}`), {
    gameState:"lobby",
    players:{
      [uid]:{ username, x:0, y:0, alive:true }
    }
  });

  sessionStorage.setItem("c", code);
  location.href="host.html";
};

// Join Party
document.getElementById("joinPartyBtn").onclick = async ()=>{
  const code = document.getElementById("joinCode").value.trim();
  if(code.length!==5) return alert("Invalid code");

  const uid = sessionStorage.getItem("uid");
  const username = sessionStorage.getItem("u");

  await set(ref(db, `parties/${code}/players/${uid}`), {
    username, x:0, y:0, alive:true
  });

  sessionStorage.setItem("c", code);
  location.href="controller.html";
};
</script>
</body>
</html>
