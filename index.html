<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SyncPlay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #1e1e2f, #111827);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .card {
      width: 95%;
      max-width: 500px;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 0 30px rgba(0,0,0,0.4);
    }

    h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    p {
      opacity: 0.7;
      margin-bottom: 30px;
    }

    button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }

    .primary {
      background: #6366f1;
      color: white;
    }

    .primary:hover {
      background: #4f46e5;
    }

    .danger {
      background: #ef4444;
      color: white;
    }

    .danger:hover {
      background: #dc2626;
    }

    input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      margin-top: 10px;
      font-size: 15px;
    }

    .party-code {
      margin-top: 20px;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 3px;
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 12px;
    }

    .hidden {
      display: none;
    }

    .user-info {
      margin-bottom: 20px;
      font-weight: 600;
    }

  </style>
</head>
<body>

<div class="card">

  <h1>SyncPlay</h1>
  <p>Host & Play Games Together</p>

  <!-- SIGN IN SECTION -->
  <div id="loginSection">
    <button id="googleLogin" class="primary">Sign in with Google</button>
  </div>

  <!-- MAIN APP -->
  <div id="appSection" class="hidden">

    <div class="user-info">
      Logged in as: <span id="displayName"></span>
    </div>

    <input id="usernameInput" placeholder="Change Username">
    <button id="saveUsername" class="primary">Save Username</button>

    <button id="createParty" class="primary">Create Party</button>

    <input id="joinCodeInput" placeholder="Enter Party Code">
    <button id="joinParty" class="primary">Join Party</button>

    <div id="partyCodeDisplay" class="party-code hidden"></div>

    <button id="logoutBtn" class="danger">Logout</button>

  </div>

</div>


<!-- Firebase -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getDatabase, ref, set, get, child } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCODp3h025sM3jl7Ji0GJgVuGoWCD1wddU",
  authDomain: "syncplay-17b6e.firebaseapp.com",
  databaseURL: "https://syncplay-17b6e-default-rtdb.firebaseio.com",
  projectId: "syncplay-17b6e",
  storageBucket: "syncplay-17b6e.firebasestorage.app",
  messagingSenderId: "86016195929",
  appId: "1:86016195929:web:40262a28786f2ead712048"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

const loginSection = document.getElementById("loginSection");
const appSection = document.getElementById("appSection");
const displayName = document.getElementById("displayName");
const usernameInput = document.getElementById("usernameInput");
const partyCodeDisplay = document.getElementById("partyCodeDisplay");


// Sign In
document.getElementById("googleLogin").onclick = async () => {
  await signInWithPopup(auth, provider);
};


// Auth state listener (NO REDIRECT)
onAuthStateChanged(auth, async (user) => {
  if (user) {
    loginSection.classList.add("hidden");
    appSection.classList.remove("hidden");

    const snapshot = await get(child(ref(db), `users/${user.uid}`));

    if (snapshot.exists()) {
      displayName.textContent = snapshot.val().username;
    } else {
      await set(ref(db, `users/${user.uid}`), {
        username: user.displayName
      });
      displayName.textContent = user.displayName;
    }
  } else {
    loginSection.classList.remove("hidden");
    appSection.classList.add("hidden");
  }
});


// Save Username
document.getElementById("saveUsername").onclick = async () => {
  const user = auth.currentUser;
  const newName = usernameInput.value.trim();

  if (!newName) return;

  await set(ref(db, `users/${user.uid}`), {
    username: newName
  });

  displayName.textContent = newName;
  usernameInput.value = "";
};


// Generate Party Code
function generateCode() {
  return Math.random().toString(36).substring(2, 8).toUpperCase();
}


// Create Party
document.getElementById("createParty").onclick = async () => {
  const user = auth.currentUser;
  const code = generateCode();

  await set(ref(db, `parties/${code}`), {
    host: user.uid,
    createdAt: Date.now()
  });

  partyCodeDisplay.textContent = "Party Code: " + code;
  partyCodeDisplay.classList.remove("hidden");
};


// Join Party
document.getElementById("joinParty").onclick = async () => {
  const code = document.getElementById("joinCodeInput").value.trim().toUpperCase();
  if (!code) return;

  const snapshot = await get(child(ref(db), `parties/${code}`));

  if (snapshot.exists()) {
    alert("Joined Party: " + code);
  } else {
    alert("Party not found");
  }
};


// Logout
document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
};

</script>

</body>
</html>
