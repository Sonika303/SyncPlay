<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "syncplay-17b6e.firebaseapp.com",
  databaseURL: "https://syncplay-17b6e-default-rtdb.firebaseio.com",
  projectId: "syncplay-17b6e",
  appId: "1:86016195929:web:40262a28786f2ead712048"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

const loginFrame = document.getElementById("loginFrame");
const partyFrame = document.getElementById("partyFrame");
const usernameInput = document.getElementById("username");
const usernameDisplay = document.getElementById("usernameDisplay");
const playerList = document.getElementById("playerList");

function showParty(){
  loginFrame.style.display="none";
  partyFrame.style.display="block";
  usernameDisplay.textContent = "Hello, " + sessionStorage.getItem("u");

  const code = sessionStorage.getItem("c");
  if(!code) return;

  onValue(ref(db, `parties/${code}/players`), snap=>{
    const players = snap.val() || {};
    playerList.innerHTML="<b>Players:</b>";
    Object.values(players).forEach(p=>{
      const d=document.createElement("div");
      d.className="player";
      d.textContent=p.username + " (Score: " + (p.score||0) + ")";
      playerList.appendChild(d);
    });
  });
}

document.getElementById("googleSignIn").onclick = async ()=>{
  const name = usernameInput.value.trim();
  if(!name) return alert("Enter username");

  const res = await signInWithPopup(auth, provider);
  sessionStorage.setItem("u", name);
  sessionStorage.setItem("uid", res.user.uid);
  showParty();
};

onAuthStateChanged(auth, u=>{
  if(u && sessionStorage.getItem("u")) showParty();
});

/* CREATE PARTY */
document.getElementById("createPartyBtn").onclick = async ()=>{
  const uid = sessionStorage.getItem("uid");
  const username = sessionStorage.getItem("u");

  const code = Math.floor(10000 + Math.random()*90000).toString();

  await set(ref(db, `parties/${code}`),{
    game:"trivia",
    gameState:"lobby",
    currentQuestion:0,
    players:{
      [uid]:{ username, score:0 }
    }
  });

  sessionStorage.setItem("c", code);
  setTimeout(()=>location.href="host.html",150);
};

/* JOIN */
document.getElementById("joinPartyBtn").onclick = async ()=>{
  const code = document.getElementById("joinCode").value.trim();
  const uid = sessionStorage.getItem("uid");
  const username = sessionStorage.getItem("u");

  await set(ref(db, `parties/${code}/players/${uid}`),{
    username,
    score:0
  });

  sessionStorage.setItem("c", code);
  setTimeout(()=>location.href="controller.html",150);
};
</script>
