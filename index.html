<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SyncPlay</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#141e30,#243b55);
  color:white;
  text-align:center;
  padding-top:60px;
}

.card{
  background:#1e1e1e;
  padding:30px;
  border-radius:12px;
  width:350px;
  margin:auto;
  box-shadow:0 0 25px rgba(0,0,0,0.4);
}

input{
  width:90%;
  padding:10px;
  margin:6px;
  border-radius:6px;
  border:none;
}

button{
  padding:10px 15px;
  margin:6px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}

.primary{ background:#4CAF50; color:white; }
.danger{ background:#e53935; color:white; }
.secondary{ background:#1976d2; color:white; }

#app{ display:none; }
</style>
</head>
<body>

<div class="card">

<h2>SyncPlay</h2>

<div id="loginBox">
  <button id="googleLogin" class="primary">Sign In with Google</button>
</div>

<div id="app">
  <p id="emailDisplay"></p>

  <input id="usernameInput" placeholder="Enter username">
  <button id="saveUsername" class="secondary">Save Username</button>

  <hr>

  <button id="createParty" class="primary">Create Party</button>

  <br>

  <input id="joinCodeInput" placeholder="Enter Party Code">
  <button id="joinParty" class="secondary">Join Party</button>

  <br><br>

  <button id="logoutBtn" class="danger">Logout</button>

  <p id="status"></p>
</div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getDatabase, ref, set, get }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCODp3h025sM3jl7Ji0GJgVuGoWCD1wddU",
  authDomain: "syncplay-17b6e.firebaseapp.com",
  databaseURL: "https://syncplay-17b6e-default-rtdb.firebaseio.com",
  projectId: "syncplay-17b6e",
  storageBucket: "syncplay-17b6e.firebasestorage.app",
  messagingSenderId: "86016195929",
  appId: "1:86016195929:web:40262a28786f2ead712048"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

const loginBox = document.getElementById("loginBox");
const appBox = document.getElementById("app");
const emailDisplay = document.getElementById("emailDisplay");
const usernameInput = document.getElementById("usernameInput");
const statusText = document.getElementById("status");

let currentUser = null;

document.getElementById("googleLogin").onclick = async () => {
  await signInWithPopup(auth, provider);
};

document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
};

onAuthStateChanged(auth, async (user)=>{
  if(user){
    currentUser = user;
    loginBox.style.display="none";
    appBox.style.display="block";
    emailDisplay.innerText="Logged in as: "+user.email;

    const snap = await get(ref(db,"users/"+user.uid));
    if(snap.exists()){
      usernameInput.value = snap.val().username;
    }

  }else{
    loginBox.style.display="block";
    appBox.style.display="none";
  }
});

document.getElementById("saveUsername").onclick = async ()=>{
  if(!currentUser) return;

  const name = usernameInput.value.trim();
  if(!name) return alert("Enter username");

  await set(ref(db,"users/"+currentUser.uid),{
    username:name,
    email:currentUser.email
  });

  alert("Saved");
};

document.getElementById("createParty").onclick = async ()=>{
  if(!currentUser) return;

  const code = Math.random().toString(36).substring(2,8).toUpperCase();

  await set(ref(db,"parties/"+code),{
    host:currentUser.uid,
    createdAt:Date.now()
  });

  window.location="host.html?code="+code;
};

document.getElementById("joinParty").onclick = async ()=>{
  if(!currentUser) return;

  const code = document.getElementById("joinCodeInput").value.trim().toUpperCase();
  if(!code) return;

  const snap = await get(ref(db,"parties/"+code));
  if(!snap.exists()){
    statusText.innerText="Party not found";
    return;
  }

  window.location="host.html?code="+code;
};

</script>

</body>
</html>
