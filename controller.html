<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SyncPlay Controller</title>
<style>
body{text-align:center;font-family:Arial;background:#fff;overflow:hidden}
#joystick{position:absolute;bottom:50px;left:50px;width:120px;height:120px;background:#ccc;border-radius:50%}
#stick{width:60px;height:60px;background:#888;border-radius:50%;position:absolute;top:30px;left:30px}
button{padding:12px;font-size:18px;margin:10px}
</style>
</head>
<body>

<h3>Controller</h3>
<div id="joystick"><div id="stick"></div></div>
<button onclick="sendJump()">JUMP</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getDatabase, ref, update, onValue } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCODp3h025sM3jl7Ji0GJgVuGoWCD1wddU",
  authDomain: "syncplay-17b6e.firebaseapp.com",
  databaseURL: "https://syncplay-17b6e-default-rtdb.firebaseio.com",
  projectId: "syncplay-17b6e",
  storageBucket: "syncplay-17b6e.firebasestorage.app",
  messagingSenderId: "86016195929",
  appId: "1:86016195929:web:40262a28786f2ead712048",
  measurementId: "G-3NBT4GJ0FX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const partyCode = sessionStorage.getItem("c") || sessionStorage.getItem("partyCode");
const uid = sessionStorage.getItem("uid");
const username = sessionStorage.getItem("u");
if(!uid||!partyCode) location.href="index.html";

const playerRef = ref(db, `parties/${partyCode}/players/${uid}`);
update(playerRef, {username, x:400, y:350, vx:0, vy:0, alive:true});

// Joystick
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");
let dx = 0, touching=false;

stick.addEventListener("touchstart",()=>{ touching=true; });
stick.addEventListener("touchend",()=>{
  touching=false; dx=0;
  stick.style.left="30px"; stick.style.top="30px";
  update(playerRef, {vx:dx});
});
stick.addEventListener("touchmove",e=>{
  if(!touching) return;
  const t = e.touches[0];
  const rect = joystick.getBoundingClientRect();
  let x = t.clientX - rect.left - 60;
  if(x<-40) x=-40; if(x>40) x=40;
  stick.style.left=(x+30)+"px";
  dx = x/10;
  update(playerRef, {vx:dx});
});

function sendJump(){
  update(playerRef, {vy:-12});
}
</script>
</body>
</html>
