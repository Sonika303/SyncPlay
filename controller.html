<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Controller</title>
<style>
body{text-align:center;font-family:Arial;background:#fff;overflow:hidden}
#joystick{position:absolute;bottom:50px;left:50px;width:120px;height:120px;background:#ccc;border-radius:50%}
#stick{width:60px;height:60px;background:#888;border-radius:50%;position:absolute;top:30px;left:30px}
button{padding:12px;font-size:18px;margin:10px}
</style>
</head>
<body>

<h3 id="status">Lobby</h3>
<div id="lobby"><button onclick="toggleReady()">READY</button></div>
<div id="countdown" style="display:none;font-size:60px"></div>
<div id="controls" style="display:none">
  <div id="joystick"><div id="stick"></div></div>
  <button onclick="sendJump()">JUMP</button>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
const u = sessionStorage.getItem("u");
const c = sessionStorage.getItem("c");
if(!u||!c) location.href="index.html";

const peer = new Peer();
let conn,ready=false,dx=0;

peer.on("open",()=>{
  conn = peer.connect(c);
  conn.on("open",()=>conn.send({type:"join",name:u}));
  conn.on("data", d => {
    if(d.type==="lobby") { status.textContent="Lobby"; }
    if(d.type==="countdown"){ lobby.style.display="none"; countdown.style.display="block"; countdown.textContent=d.value; controls.style.display="block"; }
  });
});

function toggleReady(){ ready=!ready; conn.send({type:"ready",value:ready}); }

function sendJump(){ conn.send({type:"move",dx:0,jump:true}); }

// Joystick
const stick = document.getElementById("stick");
const joystick = document.getElementById("joystick");
let touching=false;

stick.addEventListener("touchstart",()=>{ touching=true; });
stick.addEventListener("touchend",()=>{
  touching=false; dx=0; stick.style.left="30px"; stick.style.top="30px"; sendMove();
});
stick.addEventListener("touchmove",e=>{
  if(!touching) return;
  const t=e.touches[0];
  const rect=joystick.getBoundingClientRect();
  let x = t.clientX - rect.left - 60;
  if(x<-40) x=-40; if(x>40) x=40;
  stick.style.left = (x+30) + "px";
  dx = x/10; sendMove();
});

function sendMove(){ conn.send({type:"move",dx, jump:false}); }
</script>
</body>
</html>
